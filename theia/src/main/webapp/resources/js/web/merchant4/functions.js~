var mode="";
$(document).ready(function(){
	
	var walletDetails = $("#wallet-details");
	var walletAvailable = walletDetails.data("available");
	var walletBalance = walletDetails.data("balance");
	var isWalletOnly = walletDetails.data("wallet-only");
	var promocodeAvailable = $("#promocode-details").length ? true : false;
	var walletUsed = walletDetails.data("wallet-used");
	var authConfig = $("#auth-config").data("value");
	var authNewConfig=$("#auth-js-details");
	var saveCardMandatory = $("#other-details").data("save-card-mandatory");
	

	if(walletBalance)
		walletBalance = Math.round(walletBalance * 100) / 100;
	
	var paymentDetails = $("#payment-details");
	var codHybridAllowed=paymentDetails.data("cod-hybrid-allowed");
	var offlinePaymode=paymentDetails.data("offline-paymode");
	var txnAmount = paymentDetails.data("amount");
	var limeroad= paymentDetails.data("limeroad");
	var addMoneyDetails = $('#addMoney-details');
	var addMoneyAvailable = addMoneyDetails.data("available");
	var addMoneySelected = addMoneyDetails.data("selected");
	var useWallet = false;
	var hybridPaymentAllowed = paymentDetails.data("hybrid-allowed") || false;
	
	var currentPaymentType = $("#current-payment-type").data("value");
	var errorsAvailable = $("#error-details").data("available");
	var isSubscription = $("#other-details").data("subscription");
	var isSubsPPIOnly = $("#other-details").data("subs-ppi-only");
	if(isSubsPPIOnly=="Y"){isSubsPPIOnly=true;}else{isSubsPPIOnly=false;}
	var subsMode = $("#other-details").data("subs-mode");
	var saveCardAmount = $("#payment-details").data("save-card-amount");
	var isLoggedIn = $("#login-details").data("value");

	
	// setup tabs/cards
	$("body").on('click','.cards-control .card',function(e){
		$(this).siblings().removeClass("active");
		$(this).addClass("active");
		
		var tabs = $(this).parents(".cards-tabs");
		tabs.find(".cards-content .content").removeClass("active");
		
		var contentId = $(this).find("a").attr("href");
		var contentTab = tabs.find(contentId).addClass("active");
		
		var lastState = tabs.data("last-paytmcash-state");
		var cardsControl = tabs.find(".cards-control");
		cardsControl.click();
		
		if($(window).width() < 600){
			
			window.setTimeout(function(){
				$(window).scrollTop(tabs.position().top + tabs.find(".cards-content").position().top - 20);
				
			}, 100);
		} else {
			// focus first input field
			var firstInput  = contentTab.find("input[type=text], input[type=tel]").eq(0).focus();
			if(firstInput.hasClass("disabled")) // for saved cards
				contentTab.find("input[type=password]").eq(0).focus();
		}
		
		// uncheck any select saved card
//		var checkbox = tabs.find(".sc-checkbox:checked");
//		if(checkbox.length){
//			checkbox[0].checked = false;
//			checkbox.checkbox("checkChecked").trigger("change", true);
//		}
		
		if(e && e.keyCode) {
			$('.error1').removeClass('error1');
			$('.error2').addClass('hide');
		}
		
		// OFFLINE PAYMENT MODE
		if(offlinePaymode){
			if($("a[href='#cheque-dd-neft']").parent().hasClass("active")){
					$("#paytm-cash-checkbox").checkbox("click");
					disablePaytmCash();
				
			}
			else{
				if(e && e.which) {
					if($("a[href='#cheque-dd-neft']").parent().hasClass("active")==false && $("#paytm-cash-checkbox:checked").length==0 && $(".payAmount .blur-overlay").hasClass("show")==false){
					return;	
					}
				else if($("a[href='#cheque-dd-neft']").parent().hasClass("active")==false && $("#paytm-cash-checkbox:checked").length==0){
						$("#paytm-cash-checkbox").checkbox("click");
					}
				}
				enablePaytmCash();
				$(".payAmount .fullWalletDeduct").addClass("f-hide");
			}
		}
		
		
		
		return false;
	});
	
	$("body").on('click','#paytm-wallet',function(){
		$("#login-btn").click();
	});
	// setup checkbox
	$('.checkbox').checkbox();
	
	
	// setup nb and atm checkbox as radio btns
	$(".banks-panel .checkbox").on("change", function(){
		setTimeout(function(){
			$(".banks-panel .checkbox").checkbox("checkChecked");
		}, 100);
		
	});
	
	$(".banks-panel .bank-logo").click(function(){
		$(this).parents("li").find(".checkbox").checkbox("click");
	});
	
	// card border coloring
	$('.payAmount .checkbox').on("change", checkBorderStatus);
	
	function checkBorderStatus(){
		var checked = $(this)[0].checked;
		var card = $(this).parents(".card");
		if(checked){
			card.addClass("active");
			card.find(".btn-submit").addClass("active");
		} else {
			card.removeClass("active");
			card.find(".btn-submit").removeClass("active");
		}
	};
	
//	$('input').bind("cut copy paste",function(e) {
//        e.preventDefault();
//    });


	// setup promocode 
	function setupPromocode(){
		
		
		if(promocodeAvailable){
			var elm = $("#promocode-details");
			promocode = {
				type : elm.data("type"),
				paymentModes : elm.data("paymentmodes").toString().split(','),
				nbList : elm.data("nblist").toString().split(','),
				cardList : elm.data("cardlist").toString().split(','),
				cardTypeList : elm.data("cardtypelist").toString(),
				promoErrorMsg : elm.data("errormsg"),
				checkPromoValidity : elm.data("checkpromovalidity"),
				mid:elm.data("mid"),
				txnMode:elm.data("txn"),
				promocode:elm.data("promocode")
			};
			
			// hide paytm cash
			$(".payAmount").addClass("hide");
		}
		
		if(promocode.type == "DISCOUNT") {
			if(_.indexOf(promocode.paymentModes, 'PPI') != -1){
				// show paytm cash
				$(".payAmount").removeClass("hide");
			}
		}
		
		if(promocode.type == "CASHBACK") {	
		
			// hide all mode links and content
			$('.cards-content .content').addClass("f-hide");
			$('.cards-control .card').addClass("hide");
		
			// check to show/hide SC tab	
			var savedCardsMatchedCount = 0;
			if(promocode.cardList.length){ // check cards
				savedCardsElms = $('#sc-card .control-group.card');
				savedCardsMatchedCount = savedCardsElms.not(".hide").length; // valid cards
				
//				savedCardsElms.addClass("hide");
//				// match saved card bins
//				savedCardsElms.each(function() {
//					if(promocode.cardList.indexOf($.trim($(this).find('.sc-checkbox').data('firstsixdigits'))) > -1) {
//						$(this).removeClass("hide");
//						savedCardsMatchedCount++;
//					}	
//				});
			}
	
		
			// show tabs for available modes
			var showTabs = promocode.paymentModes;
		
			// check to show saved cards for not
			if(showTabs.indexOf('CC') != -1 || showTabs.indexOf('DC') != -1){
				if(savedCardsMatchedCount > 0){
					showTabs.push("SC");
				} else { // activate first tab if no sc is applicable
				}
			}
		
		
			// hide nb banks that are not available
			if(promocode.nbList.length) {
	
				// hide popular nb banks if not available
				var popularBanksAvailableCount = 0;
				$('.netbanking-panel li').each(function() {
					var bankId=$(this).find('input.checkbox').data('bankid');
					if(bankId)
						bankId=bankId.toString();
					if(promocode.nbList.indexOf(bankId) == -1){
						$(this).addClass("hide");
					} else {
						popularBanksAvailableCount++;
					}
				});
				
				// hide labels when no bank available
				if(popularBanksAvailableCount == 0){
					$("#popular-banks-wrapper").addClass("hide");
				}
				
				// hide other nb banks in dropdown if not available
				var otherBanksAvailableCount = 0;
				$('select#nbSelect option').each(function() {				
					var bankId = $(this).data('bankid');
					if(bankId)
						bankId=bankId.toString();
					if(promocode.nbList.indexOf(bankId) == -1){
						$(this).attr("disabled", "disabled");
					} else {
						otherBanksAvailableCount++;
					}
				});
				
				// hide dropdown
				if(otherBanksAvailableCount == 0){
					$("#other-banks-wrapper").addClass("hide");
				}
					
			}
		
			// show available mode tabs
			for(var i=0; i< showTabs.length; i++){
				var tab = showTabs[i];
				try{
					var link = $('a[href="#' + tab.toLowerCase() + '-card"]').parent().removeClass("hide");
					$("div#" + tab.toLowerCase() + "-card").removeClass("f-hide");
				}catch(e){
				}
			}
			
			if(_.indexOf(showTabs, 'PPI') != -1){
				// show paytm cash
				$(".payAmount").removeClass("hide");
				showAllPaymentModes();
				$(".promocode-options-msg-2, .promocode-options-msg").toggleClass('hide');
			}
			
			
			// activate first tab if tab was open
			if($('.cards-control .card.active:not(.hide)').length == 0){
				openFirstPaymentMode();
			}
		}
	
	}
	
	// unhide all modes
	showAllPaymentModes = function(){
		$('.cards-content .content').removeClass("f-hide");
		$('.cards-control .card').removeClass("hide");
		$('#sc-card .control-group.card').removeClass("hide");
		$("#popular-banks-wrapper, #other-banks-wrapper").removeClass("hide");
		$('.netbanking-panel li').removeClass("hide");
		$('select#nbSelect option').removeAttr("disabled");
		$(".payAmount").removeClass("hide");
		$(".promocode-options-msg-2, .promocode-options-msg").toggleClass('hide');
		$("a#show-other-options").hide();
		promocodeAvailable = false;
		processPayments();
	}
	// setup promocode //
	
	
	// setup saved cards //
	
	// border colors
	$('.sc-cards .checkbox').on("change", function(e, isTriggered){
		var scCards = $(this).parents(".sc-cards");
		var cardTabs = $(this).parents(".cards-tabs");
		
		scCards.find(".checkbox").each(checkBorderStatus);
		
		// open first tab when sc is unchecked
		if(!isTriggered){
			var checkbox = scCards.find(".sc-checkbox:checked");
			if(checkbox.length == 0){
				cardTabs.find(".cards-control .card").eq(0).click();
			}
		}
	});
	
	// checkboxes
	$(".sc-cards .checkbox").on("change", function(){
		$(this).parents(".sc-cards").find(".checkbox").checkbox("checkChecked");
	});
	
	// delete card
	$("body").on('click', '.deleteCard', function() {
		var savedCardId = $(this).attr('cardId');
		var savedCardNum = $(this).closest(".card").find(".savedCardLabel").val();
		
		// show confirm modal
		$("#delete-confirm-modal").toggleClass("md-show");
		
		if(!$(this).hasClass('btn-submit')){
			$("#delete-confirm-modal .deleteCard").data("confirmCardId", savedCardId);
			$("#delete-confirm-modal .del-card-num").text(savedCardNum);
		}
		
		var confirmCardId = $(this).data("confirmCardId");
		if(confirmCardId){
			savedCardId = confirmCardId;
			$.post("DeleteCardDetails", {
		     	"savedCardId": savedCardId,
		     	"MID":authNewConfig.data('mid'),
		     	"ORDER_ID":authNewConfig.data('orderid')
		    },
		    function(data,status) {
		    	if ('success' == status) {
		    		$(".deleteCard[id=delete-" + savedCardId + "]").parents(".control-group").remove();
		    		// TODO : auto select next saved card
		    		checkSavedCardsCount();
		    	}
		    });
		}
		return false;
	});
	
	
	// enable submit btn on cvv fill
	$(".scCvvInput").on("keyup", function(){
		var cvv = $(this).val();
		var card = $(this).parents(".card");
		var maxlength = parseInt($(this).attr("maxlength"));
		var minlength = parseInt($(this).attr("minlength"));
		
		var valid;
		if(card.find(".sc-icon").hasClass("MAESTRO-sc")){
			if(cvv=='' || !isNaN(cvv)){
				valid = true;
			} else {
				valid = false;			
			}
		}
		else if(card.find(".sc-icon").hasClass("AMEX-sc")){
			if(!isNaN(cvv) && (cvv.length == maxlength)){
				valid = true;
			} else {
				valid = false;			
			}
		}else{
			if(!isNaN(cvv) && (cvv.length == minlength)){
				valid = true;
			} else {
				valid = false;			
			}
		}
		card.find("#scSubmit").toggleClass("valid", valid).trigger("change-validity");
	});
	
	
	// open / close card
	$("input.sc-checkbox").on("change", function(e) {

		var form = $(this).parents("form");
		var card = $(this).parents(".card");
		var tab  = $(this).parents(".cards-tabs");
		var cards = $(this).parents('.sc-cards');
		
		form.find("#scCvvBox")[0].value = "";
		form.find(".saveCardCvvDiv").hide();
		
		// set selected card as required
		cards.find(".required").removeClass("required");
		
		// if card is selected
		var checkbox = this;
		setTimeout(function(){
			
			if(checkbox.checked){
				cards.find(".btn-submit").addClass("hide");
				form.find(".btn-submit").removeClass("hide");
				
				
				
				// uncheck other save cards
				cards.find("input.sc-checkbox").not(checkbox).each(function(){
					if(this.checked){
						this.checked = false;
						$(this).trigger("change");
					}
				});
				
				// set value hidden field
				var saveCard = $(checkbox).attr('id');
				form.find("#savedCardId")[0].value=saveCard;
				
				// show cvv box
				form.find("#cvvDiv-" + saveCard).show();
				
				
				if(!card.find("#scSubmit").hasClass('no-check')){
					card.find("#scSubmit").addClass("required");
				}
				
				
				if(form.hasClass("impsForm"))
					{
						$(".savedCardbtn").addClass("hide");
						form.find("#impsCardButton").removeClass("hide");
					}
				else{
					$(".savedCardbtn").addClass("hide");
					form.find(".savedCardbtn").removeClass("hide");
					
				}
				
				
				// close other modes tabs
			}
			
		}, 100);
		
		
		form.find(".scCvvError").hide();
		form.find(".scCvvInput").removeClass("error1").focus(); 
		
		//card.find("#scSubmit").attr("disabled", true);
	});
	
		// Inner Tabs for CHEQUE/DD/NEFT
	$("body").on('click', '.innerTabs a', function(e) {
	
		var payID=$(this).attr("href");
		var parentDiv=$(this).parents("#merchant-payment-modes");

		// Active Inner Tab
		$(".innerTabs li").removeClass("active");
		$(this).parent("li").addClass("active");
		
		//Show Inner Tab Box
		$(".neftddBox").addClass("hide");
		parentDiv.find(payID).removeClass("hide");
		
		
		return false;
	});
	
	// Inner Tab Info CHEQUE/DD/NEFT
	$("body").on("mouseover",".infoBox",function(e){
		$(this).siblings("div.info_checkDDNeft").removeClass("hide");
	});
	$("body").on("mouseout",".infoBox",function(e){
		$(this).siblings("div.info_checkDDNeft").addClass("hide");
	});
	
	// NB/DD/CHEQUE BANK LIST to UPDATE VALUE
	$("body").on("change",".offlineSelect",function(e){
		var bankNM=$(this).val();
		var form=$(this).parents("form");
		if($(this).val()){
		form.find("#bankCode").val(bankNM);
		}
	})

	// submit
	$("body").on('click', '#scSubmit', function(e){
		var form = $(this).parents("form");
		var card = form.find(".control-group.active");
		
		// set cvv in hidden field 
		var cvv = card.find(".scCvvInput").val();
		form.find("#scCvvBox")[0].value = cvv;
		
		//form.submit();
	});
	
	// check first saved cards
	$('input[name=cno][checked]').trigger("change");
	
	// setup saved cards //
	
	
	// setup emi form //
//Check EMI CC Card valid/invalid 
	$(".emi-form input.emiCCCardNumber").on("keyup change",function(){
		ccCard=$(this);
		var ccCardNoVal=$(this).val().replace(/\s/g, '');
		var form=$(this).parents("form");
		if(ccCardNoVal.length==6){
			checkboxEL=form.find('input[name=emiPlanId]:checked');
			var isAjaxRequired=checkboxEL.siblings("input.isAjaxRequired").val();
			
			
			if(isAjaxRequired=="true"){
				var emiPlanId=checkboxEL.val();
				var emiBankName =form.find("input[name=emiBankName]").val();
				var params = [];
				params.push('emiPlanId=' + emiPlanId);
				params.push('bin=' + ccCardNoVal);
				params.push('emiBankName='+ emiBankName);
				var url = "checkEmiCardValidity?" + params.join('&') + "&" + $("#queryStringForSession").data("value");
				
				//Ajax Call for CC Card check
				$.get(url, function(data, status, xhr)
				{
					var dataVal=JSON.parse(data);
					if(dataVal.isValid==0){
						form.find("div#cardInvalidmsg").show();
					}
					else{
						form.find("div#cardInvalidmsg").hide();
					}
				});
		            
			}

		}else{
			form.find("div#cardInvalidmsg").hide();
		}
	});
	
	
	
	$(".emi-form").on("change keyup", validateEmiCCForm);
	
	$(".emiBankSelect").on("change", function(){
		if($(".emi-form").find("div#cardInvalidmsg")){
		$(".emi-form").find("div#cardInvalidmsg").hide();
		}
		if($(".emi-form input.emiCCCardNumber")){
		  // $(".emi-form input.emiCCCardNumber").val("");
		}
		var map = $(this).parent();
		var selectedBank = $(this).val();
		map.find(".emi-bank-plans").addClass("hide");
		var elm = map.find("." + selectedBank + "-bank").removeClass("hide");
				
		//check for retry only
		var emiPlanId = $("#emiPlanId").data("value");
		if(emiPlanId != null && emiPlanId!=''){
		   $(elm.find('input')).each(function(){
			var planId = $(this).attr("value");
			if (emiPlanId === planId){
				$(this).checkbox("click");
				return false;
			}
			});
		}else{
			var firstPlan = elm.find('input').eq(0);
			firstPlan.checkbox("click");
		}
		var form = $(this).closest("form");
		form.find("input[name=emiBankName]").val(selectedBank);
		
		var state = selectedBank == "none" ? true : false;
		//form.find("#emiSubmit").disableButton(state);
		
		form.find(".card-details-wrapper").toggleClass("hide", state);
	});
	
	// setup emi checkbox as radio btns
	$("#emi-card .checkbox").on("change", function(){
		setTimeout(function(){
			$("#emi-card .checkbox").checkbox("checkChecked");
		}, 100);
		
	});
	
	
	// open already selected bank (in error case)
	$(".emi-bank-map:not(.hide)").find(".emiBankSelect.selected").change();
	
	// setup emi form //
	

	
	
	// setup rewards form validations //
	
	$(".btn-change-rewards-details").click(function(){
		$(".rewards-otp-form").hide();
		$(".rewards-card-form").show();
		$("#rewardsAction").val("CARD_INPUT");
		return false;
	});
	
	$(".rewards-form").on("change keyup", validateRewardsForm);
	
	function validateRewardsForm(){
		var form = $(this); 

		var programElm = form.find("#rewardsProgram"); 
		var program = programElm.val();
		var isRewardsProgramValid = program == "-1" ? false : true;
		programElm.toggleClass("valid", isRewardsProgramValid);
		
		var otpElm = form.find("#rewardsOTP"); 
		var otp = otpElm.val();
		var isRewardsOTPValid = !isNaN(otp) && otp.length == 6 ? true : false;
		otpElm.toggleClass("valid", isRewardsOTPValid);
			
		var cardInput = form.find('#rewardsCardNo');
		var cardInputHidden = form.find("input[name=cardNumber]");
		var rewardsCardNo = cardInputHidden.val();
		var isRewardsCardValid = !isNaN(rewardsCardNo) && rewardsCardNo.length >=12 ? true : false;
		cardInputHidden.toggleClass("valid", isRewardsCardValid);
		
		var mobileElm = form.find("#rewardsMobile");
		var rewardsMobile = mobileElm.val();
		var isRewardsMobileValid = !isNaN(rewardsMobile) && rewardsMobile.length == 10 ? true : false;
		mobileElm.toggleClass("valid", isRewardsMobileValid);
		
		
		if(form.find(".rewards-card-form").hasClass("hide")){
			form.find(".rewards-card-form .required").addClass("valid");
		} else { // when otp form is shown
			form.find(".rewards-otp-form .required").addClass("valid");
		}
		
		var cardType = getCardType(rewardsCardNo);

		if (cardType == "maestro") {
//			form.find('#dcStoreCardWrapper').hide();
			form.find('#maestroOpt').show();
		}
		
		if (cardType == "amex" || cardType == "diners")
			cardType = "INVALID CARD";
				
		var icon = cardType == "INVALID CARD" ? "d" : cardType;
		cardInput.removeClass('d maestro master visa diners rupay');
		cardInput.addClass(icon);
		
		form.trigger("change-validity");
		
	};
	
	// setup rewards form validations //
	
	
	// setup dc form validations //
	
	$(".dc-form").on("change keyup", validateDCForm);
	
	function validateDCForm(){
		var form = $(this);
		
		var monthElm = form.find("select.dcExpMonth");
		var month = monthElm.val();
		var isDCExpMonthValid = month == "0" ? false : true;
		monthElm.toggleClass("valid", isDCExpMonthValid);
			
		var yearElm = form.find("select.dcExpYear");
		var year = yearElm.val();
		var isDCExpYearValid = year == "0" ? false : true;
		yearElm.toggleClass("valid", isDCExpYearValid);
			
		var cvvElm = form.find("input.dcCvvBox");
		var cvv = cvvElm.val();
		
		/*
		 * @changes by Manu Pandit
		 * TODO change dcc valid value
		 * Rules as discussed with Vaishakh:
		 * In case of maestro keep cvv optional.. any length
		 * Other than mastero all cards to have 3 length
		 */
		var isDCCvvValid=false;
		if(!isNaN(cvv) && (form.find("input.dcCardNumber").hasClass("maestro") || cvv.length==3))
			isDCCvvValid=true;		
		
//		var isDCCvvValid = (!isNaN(cvv) && (cvv.length == 3 || cvv.length == 4)) ? true  : false;
		cvvElm.toggleClass("valid", isDCCvvValid);
			
		var isDCNumberValid = false;
		var cardInput = form.find('input.dcCardNumber');
		var cardInputHidden = form.find("input[name=cardNumber]");
		var cardNumber = cardInputHidden.val();
		
		if(!isNaN(cardNumber) && cardNumber.length >=12 && cardNumber.length <=19) {
			form.find(".cvv-clue-box").removeClass("hide");
			isDCNumberValid = true;
		}
		cardInputHidden.toggleClass("valid", isDCNumberValid);

		form.find('#dcStoreCardWrapper').show();
		form.find('#maestroOpt').hide();
		
		var cardType = getCardType(cardNumber);

		if (cardType == "maestro") {
//			form.find('#dcStoreCardWrapper').hide();
			form.find(".cvv-clue-box").addClass("hide");
			form.find('#maestroOpt').show();
			monthElm.add(yearElm).add(cvvElm).addClass("valid");
		}
		
		if (cardType == "amex" || cardType == "diners")
			cardType = "INVALID CARD";
				
		var icon = cardType == "INVALID CARD" ? "d" : cardType;
		cardInput.removeClass('d maestro master visa diners rupay');
		cardInput.addClass(icon);
		
		form.trigger("change-validity");
		
	};
	
	// setup dc form validations //
	
	
	
	// setup cc form validations //
	
	// only numeric cvv
	$("input[name=cvvNumber], .scCvvInput").on("keypress", isNumber);
	
	function isNumber(e){
		var charCode = (e.which) ? e.which : evt.keyCode;
	    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
	    	e.preventDefault();
	        return false;
	    }
	    return true;
	};
	
	$(".cc-form").on("change keyup", validateCCForm);
	
	// NOTE : works for both cc and emi and rewards
	function validateCCForm(){
		var form = $(this);
		
		var monthElm = form.find('select.ccExpMonth');
		var month = monthElm.val();
		var isCCExpMonthValid = month == "0" ? false : true;
		monthElm.toggleClass("valid", isCCExpMonthValid);
			
		var yearElm = form.find('select.ccExpYear');
		var year = yearElm.val();
		var isCCExpYearValid = year == "0" ? false : true;
		yearElm.toggleClass("valid", isCCExpYearValid);
		
		var cvvElm = form.find("input.ccCvvBox");
		var cvv = cvvElm.val();
		var isCCCvvValid = (!isNaN(cvv) && (cvv.length == 3)) ? true : false;
		if(form.find("input.ccCardNumber").hasClass("amex")){
		  var isCCCvvValid = (!isNaN(cvv) && (cvv.length == 4)) ? true : false;
		}
		cvvElm.toggleClass("valid", isCCCvvValid);
		
		var isCCNumberValid = false;
		var cardInput = form.find("input.ccCardNumber");
		var cardInputHidden = form.find("input[name=cardNumber]");
		var cardNumber = cardInputHidden.val();
		
		var cardType = getCardType(cardNumber);
		var clueBox = form.find(".clue-box");
		if(!isNaN(cardNumber) && cardNumber.length >=12 && cardNumber.length <=19) {
			// show cvv image
			var clueType = cardType == "amex" ? ".amex-clue" : ".default-clue";
			form.find(clueType).removeClass("hide");
			clueBox.removeClass("hide");
			
			isCCNumberValid = true;
		} else {
			form.find(".cc-cvv-clue").addClass("hide");
			clueBox.addClass("hide");
			isCCNumberValid = false;
		}
		cardInputHidden.toggleClass("valid", isCCNumberValid)
		
//		form.find('#ccStoreCardWrapper').show();
		
		/*if (cardType == "amex") {
			form.find("#ccStoreCardWrapper").hide();
		}*/
		
		var icon = cardType == "INVALID CARD" ? "c" : cardType;
		cardInput.removeClass('c amex master visa diners rupay');
		cardInput.addClass(icon);
		
		form.trigger("change-validity");
	};
	
	function validateEmiCCForm(){
		var form = $(this);
		
		var monthElm = form.find('select.ccExpMonth');
		var month = monthElm.val();
		var isCCExpMonthValid = month == "0" ? false : true;
		monthElm.toggleClass("valid", isCCExpMonthValid);
			
		var yearElm = form.find('select.ccExpYear');
		var year = yearElm.val();
		var isCCExpYearValid = year == "0" ? false : true;
		yearElm.toggleClass("valid", isCCExpYearValid);
		
		var cvvElm = form.find("input.ccCvvBox");
		var cvv = cvvElm.val();
		var isCCCvvValid = (!isNaN(cvv) && (cvv.length == 3)) ? true : false;
		if(form.find("input.emiCCCardNumber").hasClass("amex")){
		  var isCCCvvValid = (!isNaN(cvv) && (cvv.length == 4)) ? true : false;
		}
		cvvElm.toggleClass("valid", isCCCvvValid);
		
		var isCCNumberValid = false;
		var cardInput = form.find("input.emiCCCardNumber");
		var cardInputHidden = form.find("input[name=cardNumber]");
		var cardNumber = cardInputHidden.val();
		
		var cardType = getCardType(cardNumber);
		var clueBox = form.find(".clue-box");
		if(!isNaN(cardNumber) && cardNumber.length >=12 && cardNumber.length <=19) {
			// show cvv image
			var clueType = cardType == "amex" ? ".amex-clue" : ".default-clue";
			form.find(clueType).removeClass("hide");
			clueBox.removeClass("hide");
			
			isCCNumberValid = true;
		} else {
			form.find(".cc-cvv-clue").addClass("hide");
			clueBox.addClass("hide");
			isCCNumberValid = false;
		}
		cardInputHidden.toggleClass("valid", isCCNumberValid)
		
//		form.find('#ccStoreCardWrapper').show();
		
		/*if (cardType == "amex") {
			form.find("#ccStoreCardWrapper").hide();
		}*/
		
		var icon = cardType == "INVALID CARD" ? "c" : cardType;
		cardInput.removeClass('c amex master visa diners rupay');
		cardInput.addClass(icon);
		
		form.trigger("change-validity");
	};
	
	
	// for cc dc emi rewards form - refresh card no. on submit
	$("form.validated").submit(function(e){
		
		$(this).find(".ccCardNumber,.emiCCCardNumber, .dcCardNumber, rewardsCardNumber").each(function(){
			$(this).trigger("keyup");
		});
		
	});

	var formSubmitted = false;
	// false for mobile, true for web (resubmit only for mobile) 
	//var formReSubmitted = $(window).width() < 600 ? false : true;
	
	// show errors
	$(".btn-submit").click(function(e){
		
		var form = $(this).closest("form");
		var errorFound = false;
		var controlGroup= $(this).closest(".control-group");
		
		if(!(form.attr('name')=='savecard-form' && controlGroup.find('.MAESTRO-sc').length!=0)){
			try {
				form.find(".required").not(".valid").each(function(){
					showError(form, $(this));
					errorFound = true;
				});
			} catch(e){}
				
		}
		
		if(errorFound || formSubmitted)
			return false;
		
		formSubmitted = true;
		
		var spinner = $("<div class='spinner-blue'></div>");
		var disable_overlay=$("<div class='disable_overlay'></div>");
		var btn = form.find('.btn-submit.active').add(form.find('.btn-submit')); // active btn in sc or normal btn
		btn.eq(0).append(spinner);
		btn.eq(0).append(disable_overlay);
		
		var input = btn.find('input');
		var btnText = input.val();
		input.data("value", btnText);
		input.val("Processing...");
		
		// re enable button after 30 sec
		setTimeout(function(){
			formSubmitted = false;
			btn.find(".spinner-blue").remove();
			btn.find(".disable_overlay").remove();
			input.val(input.data("value"));
			
//			if(!formReSubmitted){
//				formSubmitted = false;
//				form.submit();
//				formReSubmitted = true;
//			}
			
		}, 30000);
		
		// fix for browser save password
		form.find("#ccCvvBox, #dcCvvBox").attr("type", "text").hide();
		
		setTimeout(function(){
			form.submit();
		}, 500);
		
		e.preventDefault();
		
		return true;
	});
	$("body").on('click','.savedCardbtn', function(e){
		var form = $(this).closest("form");
		var activeCard=form.find(".control-group.active");
		var cvv=activeCard.find(".scCvvInput");
		
		if($(this).hasClass("blured")){
			$('.payAmount .checkbox').checkbox("click");
		}
		
		var cvvVal=cvv.val();
		if($('.scCvvInput').closest('div').css("display")==="block"){
			
			//for maestro cvv is not required
			if(activeCard.find(".sc-icon").hasClass("MAESTRO-sc")){
				//do nothing cvv is not required
			}
			else if(activeCard.find(".sc-icon").hasClass("AMEX-sc")){
				if(cvvVal.length<4){
					cvv.focus();
					cvv.addClass("error1");
					return false;
				}
			}
			else if(form.hasClass("impsForm")){
				if(cvvVal.length<6){
					cvv.focus();
					cvv.addClass("error1");
					return false;
				}
			}
			else{
				if(cvvVal.length !=3 && !activeCard.find(".sc-icon").hasClass("SBIME-sc")){
					cvv.focus();
					cvv.addClass("error1");
					return false;
					
				}
			}
			
			
		}
		
		
		cvv.removeClass("error1");
		
		var spinner = $("<div class='spinner-blue'></div>");
		var disable_overlay=$("<div class='disable_overlay'></div>");
		var btn = form.find('.savedCardbtn').add(form.find('.savedCardbtn')); // active btn in sc or normal btn
		btn.eq(0).append(spinner);
		btn.eq(0).parent().append(disable_overlay);
		
		var input = btn.find('input');
		var btnText = input.val();
		input.data("value", btnText);
		input.val("Processing...");
		
		// re enable button after 30 sec
		setTimeout(function(){
			formSubmitted = false;
			btn.find(".spinner-blue").remove();
			btn.parent().find(".disable_overlay").remove();
			input.val(input.data("value"));
			
//			if(!formReSubmitted){
//				formSubmitted = false;
//				form.submit();
//				formReSubmitted = true;
//			}
			
		}, 30000);
		
		// fix for browser save password
		form.find("#ccCvvBox, #dcCvvBox").attr("type", "text").hide();
		
		setTimeout(function(){
			form.submit();
		}, 500);
		
		e.preventDefault();
		
		return true;
		
	});
	
	
	$("form.validated").on("change-validity", function(e){
		var form = $(this);
		form.find(".required.valid").each(function(){
			showError(form, $(this), true);
		});
	});
	
	function showError(form, elm, hide){
		var name = elm.attr("name");
		if(!name)
			return false;
		
		var label = form.find("label[for="+ name +"]");
		
		if(elm.prop("tagName") == "SELECT"){
			label = form.find("label." + elm.attr("id"));
		}
				
		label.removeClass("shake red-text");
		
		// dont show 
		if(hide)
			return false;
		
		setTimeout(function(){
			label.addClass("shake red-text");
		}, 10);
		setTimeout(function(){
			label.removeClass("shake");
		}, 2000);
	}
	
	// update card num in hidden field
	$("#cn, #cn1, #rewardsCardNo").on("keyup", function(e){
		var $target = $(e.target);
		var value = $target.val();
		$target.siblings('input[type=hidden]').val(value.replace(/ /g, ""));
	});
	
	// number spacing (doesnt work on ie, no keypress event)
	$("#cn, #cn1, #rewardsCardNo").on("keypress", function(e){
		var $target = $(e.target);
		digit = String.fromCharCode(e.which);
	    if (!/^\d+$/.test(digit)) {
	    	if(e.which !== 8){
	    		e.preventDefault();
	    	}
	      return;
	    }
		var value = $target.val();
		var maxLen = parseInt($target.attr("maxlength"));
		var re = /(?:^|\s)(\d{4})$/;
		
	    if (re.test(value) && value.length < maxLen -1) {
	      e.preventDefault();
	      return $target.val(value + ' ' + digit);
	    } else if (re.test(value + digit) && value.length < maxLen -1) {
	      e.preventDefault();
	      return $target.val(value + digit + ' ');
	    }
	    
	});
	
	// numbers only
	$("#cn, #cn1, #rewardsCardNo").on("keydown", function(e) {
	    var $target, value;
	    $target = $(e.currentTarget);
	    value = $target.val();
	    if (e.meta) {
	      return;
	    }
	    if (e.which !== 8) {
	      return;
	    }

	    if ((/\d\s$/).test(value)) {
	      e.preventDefault();
	      $target.val(value.replace(/\d\s$/, ''));
	    } else if((/\s\d?$/).test(value) == true) {
	    	$target.val(value.replace(/\s\d?$/, ''));
	    	e.preventDefault();
	    }
	});
	
	
	// check promocode bin
	if(promocodeAvailable){
		
		$('#cn, #cn1').on('blur',function() {
			var card = $(this);
			var number = card.val();
			var mode = card.data("type");
			
			if(!number)
				 return false;
			
			// BIN list
			var promoCardList = promocode.cardList;
			
			// Category list
			var promoCardTypeList = promocode.cardTypeList;
			number = number.replace(/ /g, "");
			
			var cardType = getCardType(number);
			var identifier = cardType + "-" + mode;
			
			var isCardValid = false;
			
			// check if card category-type maches cards in list
			 if(promoCardTypeList.indexOf(identifier.toUpperCase()) != -1) {
				 isCardValid = true;
			 }
			 
			 // check if card no maches cards in list
			if(!isCardValid && promoCardList.indexOf(number.substring(0,6)) != -1) {
				isCardValid = true;
			}
			
			if(_.indexOf(promocode.paymentModes, 'PPI') != -1){
				isCardValid = true;
			}
			
			 
			 $('.promo-code-error').addClass("hide");
			 if(!isCardValid) {
				 $(this).closest('form').find(".promo-code-error").removeClass("hide").text(promocode.promoErrorMsg);
			 }
			 
			 var that = this;
			 
			// check card number via ajax
			 if(isCardValid && promocode.checkPromoValidity && number.length > 12) {
				var query = "?CARD_NO=" + number;
				query+="&PROMO_CAMP_ID="+promocode.promocode;
				query+="&MID="+promocode.mid;
				query+="&txnMode="+promocode.txnMode;
				$.getJSON("checkPromoValidity" + query, function(data){
					if(data.error){
						$(that).closest('form').find(".promo-code-error").removeClass("hide").text(data.errorMsg);
					}
				});
			 }
		});
	}


	// setup cc form validations //
	// CHEQUE FORM VALIDATIONS
$(".ChequeDD-Pay").on("keyup", validateChequeForm);
	
	function validateChequeForm(){
		var form = $(this).closest("form");
	
		var chequeNoElm = $(this);
		var chequeNo = chequeNoElm.val();
		var ischequeNoValid = (!isNaN(chequeNo) && chequeNo.length == 6) ? true : false;
		chequeNoElm.toggleClass("valid", ischequeNoValid);
		form.trigger("change-validity");
	}
$("#neftNo").on("keyup", validateNEFTForm);
	
	function validateNEFTForm(){
		var form = $(this).closest("form");
	
		var chequeNoElm = $(this);
		var chequeNo = chequeNoElm.val();
		var ischequeNoValid = (!isNaN(chequeNo) && chequeNo.length > 3) ? true : false;
		chequeNoElm.toggleClass("valid", ischequeNoValid);
		form.trigger("change-validity");
	}


$(".offlineSelect").on("change", validatebankNoForm);


	function validatebankNoForm(){
		var form = $(this).closest("form");
	
		var BNKElm = $(this);
		var BNKNo = BNKElm.val();
		var isBANK_NmValid = (BNKNo != -1) ? true : false;
		if(isBANK_NmValid){
			$(this).addClass("valid");
		}
		else
		{
			$(this).removeClass("valid");
			$(this).addClass("required");
		}
		form.trigger("change-validity");
	};
	// Prefill value validation
	$(window).on("load", prefillBankname);
	function prefillBankname(){
	$(".offlineSelect").each(function(){
		var form = $(this).closest("form");
	
		var BNKElm = $(this);
		var BNKNo = BNKElm.val();
		var isBANK_NmValid = (BNKNo != -1) ? true : false;
		if(isBANK_NmValid){
			$(this).addClass("valid");
			$(this).removeClass("required");
		}
		else
		{
			
			$(this).removeClass("valid");
		}
		form.trigger("change-validity");
		});
	};
	
	
	// setup imps form validations //
	
	$(".imps-form").on("keyup", validateIMPSForm);
	
	function validateIMPSForm(){
		var form = $(this);
	
		var mobileElm = form.find("#mobileNo");
		var mobileNo = mobileElm.val();
		var isMobileNoValid = (!isNaN(mobileNo) && mobileNo.length == 10) ? true : false;
		mobileElm.toggleClass("valid", isMobileNoValid);
			
		var mmidElm = form.find("#mmid");
		var mmid = mmidElm.val();
		var isMMIDValid = (!isNaN(mmid) && mmid.length == 7) ? true : false;
		mmidElm.toggleClass("valid", isMMIDValid);
		
		var otpElm = form.find("#otp");
		var otp = otpElm.val();
		var isOTPValid = (!isNaN(otp) && otp.length > 5) ? true : false;
		otpElm.toggleClass("valid", isOTPValid);
			
		form.trigger("change-validity");
	};
	
	// setup imps form validations //
	
	
	// setup itz form validations //
	
	$(".itz-form").on("keyup", validateITZForm);
	
	function validateITZForm(){
		var form = $(this);
	
		var numberElm = form.find("#itzCashNumber");
		var cardNo = numberElm.val();
		var isCardNoValid = (!isNaN(cardNo) && cardNo.length == 12) ? true : false;
		numberElm.toggleClass("valid", isCardNoValid);
			
		var passElm = form.find("#itzPwd");
		var password = passElm.val();
		var isPasswordValid = (!isNaN(password) && password.length > 3) ? true : false;
		passElm.toggleClass("valid", isPasswordValid);
		
		form.trigger("change-validity");
	};
	
	// setup itz form validations //

	
	
	// setup nb form validations //
	
	// when netbanking popular bank is selected
	$('.netbanking-panel input.bankRadio').on("change", function(e){
		var form = $(this).parents("form");
		
		var selectElm = form.find(".nbSelect");
		if(selectElm.length)
			selectElm[0].selectedIndex = 0;
		var bankName = $(this).parent().attr('id');
		var displayName = $(this).parent().attr('title');
		form.find('#bankCode').val(bankName);
		form.find('#warningDiv').hide();
		form.find('#errorMsg').text("");
		form.find('#nbcardId').hide();
		//form.find("#nbSubmit").removeAttr("disabled").disabled(false);
		form.find("#nbSubmit").addClass("valid");
		
		// Checked to Selected Select Box
		$('#other-banks-wrapper .nbSelect option').each(function(index){
			if($(this).val()==bankName){
				$(this).prop('selected', true);
			}
		})
		
		if(maintainenceNBBank[bankName]) {
			form.find('#errorMsg').text(displayName + " is not available due to maintenance activity. If possible, pay using a different payment mode or try after sometime.");
			form.find('#warningDiv').show();
			//form.find('#nbSubmit').disableButton(true);
			form.find("#nbSubmit").removeClass("valid");
			//$('#nbSubmit').removeClass('blue-btn').addClass('gry-btn');
		} else if(lowPerfNBBank[bankName]) {
			form.find('#warningDiv').show();
			form.find('#errorMsg').text("We are facing a temporary technical issue due to which your transaction cannot be completed. Please try again after sometime.");
		}
		
		form.trigger("change-validity");
	});
	//$('.netbanking-panel input.bankRadio[checked]').trigger("change");
	
	// when netbanking other bank is selected
	$(".nbSelect").on("change", function(e){
		var form = $(this).parents("form");
		// uncheck any bank in popular list
		var elm = form.find('input.bankRadio:checked');
		if(elm && elm[0])
			elm[0].checked = false;
		// refresh
		$(".banks-panel .checkbox").checkbox("checkChecked");
		
		//Change val to Checked Upperbank/Select Bank
		var selectedBank;
		selectedBank=$(this).val();
		if($(this).val()!=-1){
			$('.netbanking-panel li div').each(function(){
				
				checkedbank=$(this);
				banksVal=$(this).attr('id');
				if(selectedBank==banksVal){
					checkedbank.find("input.bankRadio").checkbox('click');
					
				}
				
				
				
			});
		}
		
		var bankName = $(this).val();
		var displayName = $(this).find('option:checked').text();
		//$(".netbanking-panel li div a.checked").removeClass("checked");
		form.find('#bankCode').val(bankName);
		form.find('#warningDiv').hide();
		form.find('#errorMsg').text("");
		form.find('#nbcardId').hide();
		var state = (bankName == -1) ? true : false;
			
		form.find("#nbSubmit").toggleClass("valid", !state);
		
		//form.find('#nbSubmit').disableButton(state);
		
		if(maintainenceNBBank[bankName]) {
			form.find('#errorMsg').text(displayName + " is not available due to maintenance activity. If possible, pay using a different payment mode or try after sometime.");
			//panel.find('#nbSubmit').disableButton(true);
			form.find("#nbSubmit").removeClass("valid");
			form.find('#warningDiv').show();
		} else if(lowPerfNBBank[bankName]) {
			form.find('#warningDiv').show();
			form.find('#errorMsg').text("We are facing a temporary technical issue due to which your transaction cannot be completed. Please try again after sometime.");
		}
		
		form.trigger("change-validity");
	});
	$('.nbSelect option[selected]').trigger("change");
	
	// setup nb form validations //

	// setup atm form validations //
	
	$("body").on('click', '.atm-panel li div', function() {
		var form = $(this).parents("form");
		form.find('.atm-panel li div a.checked').removeClass('checked');
		$(this).find('a').addClass("checked");
		var bankName = $(this).attr('id');
		var displayName = $(this).attr('title');
		form.find('#atmBankCode').val(bankName);
		form.find('#atmWarningDiv').hide();
		form.find('#atmErrorMsg').text("");
		form.find('#atmcardId').hide();
		//form.find('#atmSubmit').removeAttr("disabled").disabled(false);
		form.find('#atmSubmit').addClass("valid");
		
		if(maintainenceATMBank[bankName]) {
			form.find('#atmErrorMsg').text(displayName + " is not available due to maintenance activity. If possible, pay using a different payment mode or try after sometime.");
			form.find('#atmWarningDiv').show();
			//form.find('#atmSubmit').disableButton(true);
			form.find('#atmSubmit').removeClass("valid");
		} else if(lowPerfATMBank[bankName]) {
			form.find('#atmWarningDiv').show();
			form.find('#atmErrorMsg').text("We are facing a temporary technical issue due to which your transaction cannot be completed. Please try again after sometime.");
		}
		
		form.trigger("change-validity");
	});
	$('.atm-panel input.bankRadio[checked]').trigger("click");

	// setup atm form validations //
	
	
	// setup cod //
	
	// hide paytm cash for COD

//	if(currentPaymentType == 12) {
//		var paytmCashCheckbox = $("#paytm-cash-checkbox");
//		if(paytmCashCheckbox.length && paytmCashCheckbox[0].checked == true){
//			$("#paytm-cash-checkbox").checkbox("click");
//		}
//		$(".payAmount").addClass("hide");
//	}
	
	// setup cod //
	
	
	// Setup login //

	$("body").on('click', '#login-btn', function(){
		showAuthView("login");
		return false;
	});
	
	$("body").on('click', '#register-btn', function() {
		showAuthView("register");
		return false;
	});
	
	// show login/register popup
	// type = "login"/"register", default - "login"
	function showAuthView(type, open) {
		var authNewConfig= authNewConfig || $("#auth-js-details");
		if(open == undefined)
			open = true;
				
		if($('#login-modal').hasClass('md-show'))
			return false;
		
		var showRegisterView = false;
		
		if(type == "register")
			showRegisterView = true;
		//TODO: remove hardcode in future
		var hostUrl = authConfig.host || authConfig.oAuthBaseUrl;
		
		var params = [];

		params.push('response_type=code');
		params.push('scope=paytm');
		params.push('theme=' + (authConfig.login_theme || 'pg'));

		if(isSubscription){
			params.push('subscription=true');
		} 
		
		var client_id = authConfig.client_id;
		var wap_client_id = authConfig.wap_client_id;
		

		var returnUrl = authConfig.return_url;
		params.push('redirect_uri=' + returnUrl);
		if(authConfig.EMAIL)
			params.push('email-prefill=' + authConfig.EMAIL);
		
		params.push('ADDRESS1=' + authConfig.ADDRESS1);
		params.push('ADDRESS2=' + authConfig.ADDRESS2);
		
		if(authConfig.MSISDN)
			params.push('mobile-prefill=' + authConfig.MSISDN);
		
		var txnTransientId = $("#txnTransientId").data("value");
		
		var isMobile = $(window).width() < 600;
		
		var detectedChannel = isMobile ? "WAP" : "WEB";
		
		var jsessionid = $("#other-details").data("jsessionid");
		var loginType = open ? "MANUAL" : "AUTO";
		var eid = authConfig.eid;
		var jvmRoute = $("#jvmRoute").data("value");
		//TODO comment this line in future when testing done
//		params.push("state=" + authConfig.ORDERID + ":" + authConfig.MID + ":" + txnTransientId + ":" + detectedChannel + ":" + jsessionid + ":" + loginType + ":" + eid + ":" + jvmRoute);
		params.push("state=" + authNewConfig.data('orderid') + ":" + authNewConfig.data('mid') + ":" + detectedChannel + ":" + jsessionid);

		var view = "/oauth2/authorize";
		if(showRegisterView == true)
			view = "/register";
		
		
		// check for wap version
		if(isMobile){
			params.push('client_id=' + wap_client_id);
			params.push('device=mobile');
		} else {
			params.push('client_id=' + client_id);
		}
//		params.push('client_id=' + 'paytm-pg-client-staging');
		// check for auto register
		if(open && authConfig.auto_signup){
			params.push('auto-signup=true');
			if(authConfig.titletext)
				params.push('titletext=' + authConfig.titletext);
		}
		/*
		 * check if any of params is undefined
		 * if it's undefined change it to ''
		 */
		for(var i=0;i<params.length;i++){
			if(params[i]==undefined)
				params[i]='';
		}
		
		var src = hostUrl + view + "?" + params.join('&');
		src = encodeURI(src);
		
		// redirect
		if(open){
			if(isMobile){
				setTimeout(function(){
					window.location.href = src;
				}, 100);
				return true;
			} else {
				$('#login-modal').addClass('md-show');
			}
		}
		
		$('#login-iframe').attr('src', src);
		$('#login-iframe').one("load", function(e){
			$(this).addClass("loaded");
		});
		
		// fix For IE
		if($.support){
			if(!$.support.opacity){
				$('.md-overlay').css({ "filter" : "alpha(opacity=60)"});
			}
		}
		
		// setCentered
		// set position to center the popup
//		var topMargin = $('#login-modal').height() / 2;
//		var leftMargin = $('#login-modal').width() / 2;
//
//		$('#login-modal').css({ "margin-top" : -topMargin, "margin-left" : -leftMargin});

		// Tracking manual/auto login
	     try{
			var url =  $(open ? '#pgTrackUrlManual' : '#pgTrackUrlAuto').val();
		
			if(url!=null && url!='' && url!='null'){
				var ele = document.createElement("img");
				ele.src= url;		  
			}
		}catch(e){}
		
	}

	$("body").on('click', '#logout-btn', function() {
		doLogout();
		return false;
	});
	
	function doLogout() {
		
//		console.log($("#auth-config"));
		var authConfig = $("#auth-config").data("value");
		var authNewConfig=$("#auth-js-details");
		//TODO: change auto url with new url once confirmed
		var logoutUrl = authConfig.AUTH_LOGOUT_URL + "/" + authConfig.PAYTM_TOKEN;
		
		var params = [];
		var returnUrl = authConfig.AUTH_LOGOUT_RETURN_URL + "?" + $("#queryStringForSession").data("value");
		params.push('redirect_uri=' + returnUrl);
		
		
		var src = logoutUrl + "?" + params.join('&');
		src = encodeURI(src);
		$('#logout-iframe').attr('src', src);
		$('#logout-iframe').one("load", function(e){
			// logout req done
			window.location = returnUrl;
		});
	}
	

	$("body").on('click', '.close-modal', function(e) {
		e.stopPropagation();
		$(this).closest(".md-modal").removeClass('md-show');
		$('.md-overlay').removeClass('md-overlay-show');
		$('#login-iframe').attr('src', '');
		return false;
	});
	
	// Setup login //

	function getCardType(cardNumber) {
		var first = cardNumber.substring(0, 1);
		var firstTwo = cardNumber.substring(0, 2);
		var firstFour = cardNumber.substring(0, 4);
		var firstSix = cardNumber.substring(0, 6);
		var res;
		
		if(cardNumber.length == 19) {
			res = "maestro";
		} else if (firstTwo == "30" || firstTwo == "36" || firstTwo == "38" || firstTwo == "35") {
			res =  "diners";
		} else if (firstTwo == "34" || firstTwo == "37") {
			res =  "amex";
		} else if (first == "4") {
			res =  "visa";
		} else if (checkRange(firstTwo, 51, 55)) {
			res =  "master";
		} else if ( firstFour == "6011") {
			res =  "DISCOVER";
		} else if (checkRange(firstSix, 508500, 508999) || checkRange(firstSix, 606985, 607984) || checkRange(firstSix, 608001, 608500) || checkRange(firstSix, 652150, 653149) ) {
			res =  "rupay";
		} else if (firstTwo == "50" || checkRange(firstTwo, 58, 62) ) {
			res = "maestro";
		} else if (cardNumber.length == 0){
			res = "INVALID CARD";
		} else {
			res = "none";
		}
		
		return res;
	}
	
	function checkRange(num, a, b){
		return (num >= a && num <= b) ? true : false;
	}
	
	function bindOnceBlur(){
		$("#merchant-payment-modes .card").one("click", clickOnBlured);
		$("#paytm-cash-checkbox").one("change", clickOnBlured);
	}
	
	function clickOnBlured(e){
		e.preventDefault();
		if($(e.target).hasClass('sc-checkbox'))
			return false;
		$("#merchant-payment-modes .card").off("click", clickOnBlured);
		$("#paytm-cash-checkbox").off("change", clickOnBlured);
		// only for click on blured area
		if(!$(e.target).hasClass('checkbox'))
			$("#paytm-cash-checkbox").checkbox("click");
	}
	
	
	function initPayments(){
		
		// on paytmcash checkbox change
		$("body").on('change', '#paytm-cash-checkbox', function(e){
			useWallet = $("#paytm-cash-checkbox")[0].checked;
			processPayments();
		});
		
		
		// use wallet by default (if available)
		if(walletAvailable){
			useWallet = true;
		} else {
			// disable paytmcash
			$("#paytm-cash-checkbox").checkbox("toggleEnabled");
		}
	
		// set class on disabled elems
		$('*[disabled=disabled]').disabled(true);
		
		processPayments();
		
		//checkSavedCardsCount();

		if(promocodeAvailable){
			try{
				setupPromocode();
			}catch(e){
				var er = e;
			}
		}
		
	};
	
	function checkSavedCardsCount(){
		// hide/show msg for other paymnt methods
		try {
			var num = $('.sc-cards .control-group.card').length;
			if(num == 0){
				$('a[href="#sc-card"]').parent().remove();
				$('.cards-control').each(function(){
					$(this).find(".card").eq(0).click();
				});
			}
		}catch(e){}
			
	};
	
	
	// payments starts here...
	initPayments();
	
	
	// rebuilds ui
	function processPayments() {
		
		
		var totalAmount = txnAmount;
		
		var paidAmount = totalAmount;
		var remWalletBalance = 0;

		$("#totalAmountSpan, .totalAmountSpan").text(numberWithCommas(totalAmount));
		
		if(walletAvailable){
			$('#yourBal').show();
			$('#yourBal .amt').text(numberWithCommas(walletBalance));
			
			// calculate balance used
			var balanceUsed = walletBalance >= totalAmount ? totalAmount : walletBalance;
			$("#balance-used").text(numberWithCommas(balanceUsed));
		}
		
		// identify mode 
		 mode = "";
		if(useWallet) {
			if(walletBalance >= totalAmount) { // sufficient balance
				mode = "full-wallet"; // full wallet payment
				if(isSubscription){
					mode = "subs-full-wallet";
				}
				
			} else { // insufficient balance
				
				if(isSubscription){
					mode = "subs-default";
				} else if(addMoneyAvailable){
					mode = "add-money"; // wallet with add money
				} else if(hybridPaymentAllowed && walletBalance > 0){
					mode = "hybrid"; // hybrid payment
				} else {
					mode = "no-wallet"; // only bank payment
				}
				
			}
			
		} else {
			mode = "default"; // default 
		}
		
		//For retry purpose only
		var retryPaymentMode = $("#retryPaymentMode").data("value");
		if(retryPaymentMode != null && retryPaymentMode!=''){
				$(".cards-control .card").each(function(){
					var index = $(this).find("a").attr("href").toLowerCase().indexOf(retryPaymentMode);
					if (index >= 0){
						$(this).addClass("active");
						//Setting value for form related to particular paymentMode
						/*var retryMode=""; 
						if($('#add-money-payment-modes').length>0){ 
							retryMode="add-money"; 
						} 
						else{ 
							retryMode="normal"; 
							}*/
						//if(retryMode == "add-money")
						if(mode == "add-money")
							$('#add-money-payment-modes a[href="#'+ retryPaymentMode +'-card"]').click();
						else
							$('#merchant-payment-modes a[href="#'+ retryPaymentMode +'-card"]').click();
						return false;
					}
					});
		}
		//End
		
		
		// default mode in case of promocode
		var promoPaymentModes = promocodeAvailable && $("#promocode-details").data("paymentmodes").toString().split(',');
		if(promocodeAvailable && _.indexOf(promoPaymentModes, 'PPI') == -1){ 
			mode = "default";
		}
		
		
		
		// set mode based on current payment type (used in case of error showing)
		if(errorsAvailable){
			errorsAvailable = false;
			
			// case - errors + no-wallet
			if(mode == "no-wallet"){
				disablePaytmCash();
			}
			
			//if(addMoneySelected){
			if(walletUsed || addMoneySelected || isSubscription){
				// dont change mode
				openPreferedModeTab(mode);
			} 
			else {
				mode = "default";
			}
		}
		
		// check paytmcash checkbox for valid modes
		if(_.indexOf(["full-wallet", "hybrid", "add-money", "subs-full-wallet", "subs-default"], mode) != -1){
			var paytmCashCheckbox = $("#paytm-cash-checkbox");
			// click checkbox if its not clicked
			if(paytmCashCheckbox.length && paytmCashCheckbox[0].checked == false){
				$("#paytm-cash-checkbox").checkbox("click");
				return false;
			}
		}
		
		// show emi normal map
		$(".emi-bank-map-1").removeClass("hide");
		$(".emi-bank-map-2").addClass("hide");
		
		// hide add money modes by default
		$("#merchant-payment-modes").removeClass("hide");
		$("#add-money-payment-modes").addClass("hide");
		// hide all msgs
		$("#payment-user-msg .msg").addClass("hide");
		// hide full wallet submit btn
		$('.fullWalletDeduct').addClass("f-hide");
		
		$('.fullWalletDeduct').addClass("f-hide");
		
		$("#cod-msg").show();
		$('#cod-hybrid-msg').hide();
		$("a[href='#cod-card']").parent().removeClass("hide");
		
		
		
		
		switch(mode){
			case "default" : 
				unblurAllModes();
				paidAmount = totalAmount;
				$('#yourBal .amt').text(numberWithCommas(walletBalance));
				$('input[name=walletAmount]').val('0');
				$('#walletBalance, #remBal').hide();
				$('#yourBal').show();
				$('#remBal').hide();
				$("#remWalletBal .amt").text(Math.round(walletBalance * 100) / 100);
				$(".hybridMoneyAmount").text(numberWithCommas(paidAmount));
				// show heading text
				$(".bankPaymentText").removeClass("hide");
				$('.balance-used-box').addClass("hide");
				if(isSubscription){
					
					if(subsMode == "CC"){
						$(".bankPaymentText").addClass("hide");
						$(".subs-default-msg").removeClass("hide");
					}
					
					if(paidAmount == 0){
						$("#cc-card").find(".storeCardWrapper").append($(".subs-min-amt-msg").eq(0).clone().removeClass("hide"));
						// hide cvv box & make submit btn valid
						$('.scCvvInput').parent('div').hide();
						$('input[id=scSubmit]').addClass("valid");
					}
				}
				$("#fullWalletPayTxt").addClass("hide");
				$("#defultPayTxt").removeClass("hide");
				$(".exactPayment").addClass("hide");
				$("#paymentBox").hide();
				
				$("#walletAmountRem").removeClass("hide");
				$("#walletAmountRem .walletAmountRemTxt").text(numberWithCommas(walletBalance));
				
			break;
			
			case "no-wallet" :
				// show heading text
				$(".bankPaymentText").removeClass("hide");
				disablePaytmCash();
				$(".exactPayment").addClass("hide");
				$("#paymentBox").hide();
				$("#defultPayTxt").removeClass("hide");
				
				$("#walletAmountRem").removeClass("hide");
				$("#walletAmountRem .walletAmountRemTxt").text(numberWithCommas(walletBalance));
				
			break;
			
			case "full-wallet" :
				blurAllModes();
				bindOnceBlur();
				
				paidAmount = totalAmount;
				remWalletBalance = walletBalance - totalAmount;
				$('input[name=walletAmount]').val(totalAmount);
				$('.fullWalletDeduct').removeClass("f-hide");
				$('.balance-used-box, .fullWalletText').removeClass("hide");
				
				$("#remWalletBal .amt").text(Math.round(remWalletBalance * 100) / 100);
				$("#fullWalletPayTxt").removeClass("hide");
				$("#defultPayTxt").addClass("hide");
				$(".exactPayment").addClass("hide");
				$("#paymentBox").show();
				
				$("#walletAmountRem").addClass("hide");
				$("#walletAmountRem .walletAmountRemTxt").text(numberWithCommas(walletBalance));
			break;
				
			case "hybrid" :
				paidAmount = totalAmount - walletBalance;
				paidAmount = Math.round(paidAmount * 100) / 100;
				$('input[name=walletAmount]').val(walletBalance);
				
				// show heading text
				$('.hybridPaymentText').removeClass("hide");
				$('.balance-used-box').removeClass("hide");
				$(".hybridMoneyAmount").text(numberWithCommas(paidAmount));
				
				$("#hybrid-mode-paybox").css('display', 'block');
				$("#hybrid-mode-sign").css('display', 'block');
				$("#paybox-hybrid").addClass("hide");
				$("#sign-hybrid").addClass("hide");
				
				// show emi hybrid map
				$(".emi-bank-map-1, .emi-bank-map-2").toggleClass("hide");
				
				$("#cod-msg, #cod-hybrid-msg").toggle();
				$("#cod-amount").text(paidAmount);
				
				// open already selected bank (in error case)
				$(".emi-bank-map:not(.hide)").find(".emiBankSelect.selected").change();
				if(codHybridAllowed!=true){
					$("a[href='#cod-card']").parent().addClass("hide");
					$("#cod-card").removeClass("active");
					if($("a[href='#cod-card']").parent().hasClass("active")){
						$(".cards-control .card:not(.hide) a").eq(0).click();
					}
					
				}
				
				if(offlinePaymode){
						if($("a[href='#cheque-dd-neft']").parent().hasClass("active")){
							$("#paytm-cash-checkbox").checkbox("click");
							disablePaytmCash();
						}
						
				}
				$("#remWalletBal .amt").text(numberWithCommas(0));
				$("#fullWalletPayTxt").addClass("hide");
				$("#defultPayTxt").removeClass("hide");
				$(".exactPayment").removeClass("hide");
				$("#paymentBox").show();
				
				$("#walletAmountRem").addClass("hide");
				
			break;
				
			case "add-money" :
				paidAmount = totalAmount - walletBalance;
				paidAmount = Math.round(paidAmount * 100) / 100;
				$("#merchant-payment-modes").addClass("hide");
				$("#add-money-payment-modes").removeClass("hide");
				
				$('input[name=walletAmount]').val(walletBalance);
				
				$(".addMoneyAmount").text(numberWithCommas(paidAmount));
				$('.balance-used-box').removeClass("hide");

				$("#hybrid-mode-paybox").css('display', 'block');
				$("#hybrid-mode-sign").css('display', 'block');
				$("#paybox-hybrid").addClass("hide");
				$("#sign-hybrid").addClass("hide");
				$("#addMoneyAmtBox").removeClass("hide");
				
				// show heading text
				$(".addMoneyText").removeClass("hide");
				openPreferedModeTab(mode);
				$("#remWalletBal .amt").text(0);
				$("#fullWalletPayTxt").addClass("hide");
				$("#defultPayTxt").removeClass("hide");
				$(".exactPayment").removeClass("hide");
				$("#paymentBox").show();
				
				$("#walletAmountRem").addClass("hide");
				
			break;
			
			case "subs-default" : 
				//unblurAllModes();
				paidAmount = totalAmount - walletBalance;
				paidAmount = Math.round(paidAmount * 100) / 100;
				$("#merchant-payment-modes").addClass("hide");
				$("#add-money-payment-modes").removeClass("hide");
				
				$('input[name=walletAmount]').val(walletBalance);
				
				$('#yourBal .amt').text(numberWithCommas(walletBalance));
				$("#remWalletBal .amt").text(numberWithCommas(0));
				
				if(isSubsPPIOnly){
					$(".subs-ppi-only-complete-payment").removeClass("hide");
				} else {
					$(".subs-complete-payment").removeClass("hide");
				}
				
				$(".addMoneyAmount").text(numberWithCommas(paidAmount));
				
				$('.balance-used-box').removeClass("hide");
				$('#walletBalance, #remBal').hide();
				$('.bankPaymentText, #yourBal').show();
				$(".fullWalletDeduct").addClass("f-hide");
				
				$("#payment-user-msg .msg").addClass("hide");
				
				// enable save card checkbox
				if(isSubsPPIOnly){
					$('input[name=storeCardFlag][type=checkbox]').checkbox("toggleEnabled");
				}

				openPreferedModeTab("subs-default");
				/*MTS SUBSCRIPTION CHECK REMOVE
				$(".exactPayment").addClass("hide");
				$("#paymentBox").hide();
				$(".payAmount").addClass("hide");
				
				$("#walletAmountRem").addClass("hide");
				*/
				
			break;
				
			case "subs-full-wallet" :
				paidAmount = totalAmount;
				$("#merchant-payment-modes").addClass("hide");
				$("#add-money-payment-modes").removeClass("hide");
				
				$('input[name=walletAmount]').val(totalAmount);
				$('.fullWalletDeduct').addClass("f-hide");
				$('.bankPaymentText').hide();
				
				//$(".addMoneyAmount").text(numberWithCommas(paidAmount));
				$(".saveCardAmount").text(numberWithCommas(saveCardAmount));
				$('.balance-used-box').removeClass("hide");
				// show heading text
				
				// dont show wallet in case of zero balance
				if(paidAmount == 0)
					$(".wallet-pay-text, .payAmount").addClass("hide");
				
				// if saved cards are available
				if($("input.sc-checkbox").length){
					$(".subs-select-card").removeClass("hide");
					$(".storeCardWrapper").append($(".subs-min-amt-msg").eq(0).clone().removeClass("hide"));
				} else {
					$(".subs-save-card").removeClass("hide");
				}
				
				// hide cvv box and enable save card submit
				$('.scCvvInput').parent('div').hide();
				// enable sc submit btn
				$('input[id=scSubmit]').addClass("valid");
				
				if(isSubsPPIOnly){
					$('.fullWalletDeduct').removeClass("f-hide");
					$(".payAmount").removeClass("hide");
					$('.subs-text, .wallet-pay-text, .subs-msgs .hr').addClass('hide');
					$('.subs-only-full-wallet').removeClass('hide');
				}
				$(".exactPayment").addClass("hide");
				$("#remWalletBal").hide();
				$("#paymentBox").show();
				
				$("#walletAmountRem").addClass("hide");
				
			break;
		}
		
		$('.finalAmountSpan').html(numberWithCommas(paidAmount));
		// limeroad Subtheme Amount Button
		if(limeroad){
			$("form .btn-submit input").val("Pay Rs. "+numberWithCommas(paidAmount)+"/-");
		}

		
	}
	
	
	function openPreferedModeTab(mode){
		var showTab = null;
		
		switch(currentPaymentType){
			case 5 : // sc
				/// check sc
				//hide other-methods-msg
				showTab = "sc";
			break;
			case 1 : // cc
				showTab = "cc";
			break;
			case 2 : // dc
				showTab = "dc";
			break;
			case 3 : // nb
				showTab = "nb";
			break;
			case 8 : // atm
				showTab = "atm";
			break;
			case 6 : // ims
				showTab = "imps";
			break;
			case 11 : // rewards
				showTab = "rewards";
			break;
			case 13 : // emi
				showTab = "emi";
			break;
			default:
				openFirstPaymentMode(mode);
			break;
		}
		
		if(showTab){
			
			if(mode == "add-money" || mode=="subs-default" || mode=="subs-full-wallet")
				$('#add-money-payment-modes a[href="#'+ showTab +'-card"]').click();
			else
				$('#merchant-payment-modes a[href="#'+ showTab +'-card"]').click();
		}
		
	};
	
	// open first tab
	function openFirstPaymentMode(mode) {
		if(mode == "add-money")
			$('#add-money-payment-modes .cards-control .card:not(.hide) a').eq(0).click();
		else
			$('#merchant-payment-modes .cards-control .card:not(.hide) a').eq(0).click();
	}
	
	function checkPaytmCashCheckbox(state){
		state = state || false;
		
		var paytmCashCheckbox = $("#paytm-cash-checkbox");
		if(paytmCashCheckbox.length && paytmCashCheckbox[0].checked != state){
			$("#paytm-cash-checkbox").checkbox("click");
		}
	}
	
	function disablePaytmCash(){
		$('.fullWalletDeduct').addClass("f-hide");
		$('#remBal').hide();
		$(".payAmount .blur-overlay").addClass("show");
		$('.balance-used-box').addClass("hide");
	}
	
	function enablePaytmCash(){
		$('.fullWalletDeduct').removeClass("f-hide");
		$('.balance-used-box').removeClass("hide");
		$(".payAmount .blur-overlay").removeClass("show");
	}
	
	
	function blurAllModes(){
		
		toggleMerchantModes(false);
	}
	
	function unblurAllModes(){
		
		toggleMerchantModes(true);

	}
	
	function toggleMerchantModes(show){
		var merchant = $("#merchant-payment-modes");
		var control = merchant.find(".cards-control");
		var overlay = $("#merchant-payment-modes .card");
		
		
		if(show == false){
			overlay.addClass("blured");
			$(".savedCardbtn").addClass("blured");
		} else {
			
			$(".scCvvInput").focus();
			overlay.removeClass("blured");
			$(".savedCardbtn").removeClass("blured");
			// activate first mode
			if(merchant.find(".cards-control .card.active").length == 0)
				merchant.find(".cards-control .card").first().click();
		}
		
	}
	
	// setup payment details btn //
	$(".btn-show-payment-details").click(function(){
		$('.payment-details').toggle();
		$(this).hide();
		$(".btn-hide-payment-details").show();
		return false;
	});
	
	$(".btn-hide-payment-details").click(function(){
		$('.payment-details').toggle();
		$(this).hide();
		$(".btn-show-payment-details").show();
		return false;
	});
	// setup payment details btn //
	
	
	// setup notification popover
	$("#login-btn, #register-btn, .popover-close a").click(function(){
		$(".login-popover").hide();
	});
	
	
	
	// setup login check //
	if($("#login-btn").length){
		//TODO: change after taken
		if(authConfig.autoLogin != "N"){
			var open = authConfig.autoLogin == "M" ? true : false; 
			//check for retry count -- if retry count>=1 don't submit login request
			if(parseInt(authNewConfig.data('retrycount'))<=0){
			showAuthView("login", open);
			}
			else{
				$("#login-stitch, #login-wait").toggle();
			}
		}
	}
	
	$("#login-iframe").one("load", function(){
		setTimeout(function(){
			// fix for mozilla for load event on empty iframe
			if($("#login-btn").length == 0)
				return false;
			
			$("#login-stitch, #login-wait").toggle();
			if(!isLoggedIn && isWalletOnly)
				showAuthView();
		}, 1000);
	});
	
	// hide login notification if preset
	setTimeout(function(){
		var elm = $("#login-success-alert").addClass("closed");
		setTimeout(function(){
			elm.hide();
			$('.summary-card').addClass("mb20");
		}, 500);
	}, 3000);
	
	
	// setup login check //
	
	
	
	// setup wallet and wallet only //
	
	
	
	if(isWalletOnly){
		// auto open login popup
		//$("#login-btn").click();
		
		// cancel txn on close popup
		$("body").one('click', '.closePop', function(e) {
			var target = $("#login-iframe").hasClass("loaded") ? "login" : "pre-login";
 			cancelTxn(e, {target : target});
			return false;
		});
		
		
		
		// adjust footer
//		if($(window).width() > 600 && $(document).height() < $(window).height()){
//			$("#footer").addClass("fixed-bottom");
//			$("#footer-placeholder").removeClass("hide");
//		}
		
		// disable paytmcash checkbox
		var elm = $("#paytm-cash-checkbox");
		if(!elm.hasClass("disabled"))
			elm.checkbox("toggleEnabled");
	}
	
	// setup wallet and wallet only //
	
	// setup wap theme //
	
	if($(window).width() < 600){
		$('#login-modal').hide();
		
		// change type of cvv field
		$("input.type-tel").attr('type', 'tel');
	}

	// setup wap theme //
	
	// setup iframe flow
	document.cookie = "testcookie=true";
	
	if(!/testcookie/.test(document.cookie)){
		
		var JSESSIONID = $("#other-details").data("jsessionid");
		var action = $("form").attr("action"); 
		action = action.split("?");
		var submitUrl = action[0] + ";jsessionid=" + JSESSIONID;
		if(action.length > 1) {
			submitUrl = submitUrl + "?" + action[1];
		}
		$("form").attr("action", submitUrl);
		
		var href = $("a.cancel").attr("href");
		href = href.split("?");
		var cancelUrl = href[0] + ";jsessionid=" + JSESSIONID;
		if(href.length > 1) {
			cancelUrl = cancelUrl + "?" + href[1];
		}
		$("a.cancel").attr("href", cancelUrl);
	}

	// cancel button
	$("a.cancel").click(cancelTxn);
			
	function cancelTxn(e, data){
		var that = this;
		if(data && data.fake)
			return;
		
		var url = "/theia/cancelTransaction?" + $("#queryStringForSession").data("value");
		if(data && data.target)
			url += "&target=" + data.target;
		
		$.get(url, function(html, status){
			if(status == "success"){
				var regex = /<FORM[\s\S]*<\/FORM>/;
				var formStr = regex.exec(html);
				if(!formStr)
					return $(that).trigger("click", {fake:true}); // no fallback when func directly called
				$("body").append(formStr[0]);
				var form = $("form[name=TESTFORM]")[0];
				if(window.top !== window){
					form.target="_parent";
				}
				form.submit();
			}
		});
	
		e.preventDefault();
	}
	

	// track page load
	 try {
	 	trackEvent("onload");
	 } catch(e){};
	 
	 function trackEvent(e){
		 var txnTransientId = $("#txnTransientId").data("value");
		 
		 if(e == "onload"){
			 /*$.post("/oltp/HANDLER_INTERNAL/UPDATE_OPEN?JsonData={TXNID:" + txnTransientId+ "}", null, function(res){
				var status = res;
			 });*/
		 }
	 }
	 
	 // disable save card checkbox (used for some promocodes)
	 if(saveCardMandatory){
		$('input[name=storeCardFlag][type=checkbox]').not('[disabled]').checkbox("toggleEnabled");
	 }
	 
	// setup subscription //
	 if(isSubscription){
		
		// disable save card checkbox
		$('input[name=storeCardFlag][type=checkbox]').checkbox("toggleEnabled");
		
		$(".payAmount").removeClass("active");
		
		// hide checkbox
		$(".walletCheckbox").hide();
		
		$(".payAmount .text-box").removeClass("ml20");
	 }
	// setup subscription //
//Fix Safari Bug (Login View Popup)
	 var N= navigator.appName;
	 var UA= navigator.userAgent;
	 var temp;
	 var browserVersion= UA.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
	 if(browserVersion && (temp= UA.match(/version\/([\.\d]+)/i))!= null)
	 browserVersion[2]= temp[1];
	 browserVersion= [browserVersion[1], browserVersion[2].substring(0,2)];
	 if(browserVersion[0]=='Safari'){
	 	if(browserVersion[1]<6){
	 		$("#login-modal,#delete-confirm-modal").removeClass("md-effect-10");
	 		$(".md-overlay").css("-webkit-transition","none");
	 	}
	 }
	 
	 //MTS THEME CHECK IF SAVED CARD IS NOT WORKING FIRST TAB ACTIVE
	 $(".cards-tabs").each(function(){
		 if(!$(this).hasClass("hide")){
			 if(!$($(this)).find(".cards-control .card").hasClass("active")){
				 $($(this)).find(".cards-control .card").eq(0).click();
			 }
		 }
	 });
	 
	/*if(!$(".cards-tabs .cards-control .card").hasClass("active")){
		$(".cards-tabs .cards-control .card").eq(0).click();
	} */
	
	  //for contents cards active more than 1
	 (function DisabledMoreThanOneActive(){
		 if($('.card.content.active').length>1){
			 $('.card.content.active').removeClass('active');
			 openFirstPaymentMode(mode);
		 }
	 })();
	
	 
}); // $ ready ends


// trim function
if(typeof String.prototype.trim !== 'function') {
  String.prototype.trim = function() {
    return this.replace(/^\s+|\s+$/g, ''); 
  };
}

// underscore utils
_ = {};
var ArrayProto = Array.prototype;
var nativeIndexOf = ArrayProto.indexOf;
_.indexOf = function(array, item, isSorted) {
    if (array == null) return -1;
    var i = 0, length = array.length;
    if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);
    for (; i < length; i++) if (array[i] === item) return i;
    return -1;
  };
  
//jquery plugin to add/remove disabled class 
$.fn.disabled = function(state){
 
 state = state || false;
 
 if(state)
	 $(this).addClass("disabled");
 else
	 $(this).removeClass("disabled");
};

//jquery plugin to disable button
$.fn.disableButton = function(state){
	state = state || false;
	$(this).disabled(state);
	if(state)
		$(this).attr("disabled", "disabled");
	else
		$(this).removeAttr("disabled");
	
	return $(this);
};

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}